pipeline {
    agent {
        label 'windows-node'
    }
    environment {
        NVM_VERSION = '1.2.0'
        NVM_URL = 'https://github.com/coreybutler/nvm-windows/releases/download/1.2.0/nvm-setup.zip'
        NVM_INSTALL_DIR = 'C:\\nvm'
    }
    stages {
        stage('Install NVM if not Present') {
            steps {
                powershell """
                Start-Process powershell -ArgumentList '-NoProfile -Command {
                    # Check if NVM is installed
                    if (-Not (Get-Command nvm -ErrorAction SilentlyContinue)) {
                        Write-Output "NVM is not installed. Installing now..."

                        # Check if the NVM installation directory exists
                        if (Test-Path "${env.NVM_INSTALL_DIR}") {
                            # Empty the directory if it exists
                            Remove-Item -Recurse -Force "${env.NVM_INSTALL_DIR}\\*" 
                            Write-Output "NVM installation directory cleared: ${env.NVM_INSTALL_DIR}"
                        } else {
                            # Create the directory if it doesn't exist
                            New-Item -ItemType Directory -Force -Path "${env.NVM_INSTALL_DIR}"
                            Write-Output "NVM installation directory created: ${env.NVM_INSTALL_DIR}"
                        }

                        # Download NVM
                        Invoke-WebRequest -Uri "${env.NVM_URL}" -OutFile "$env:TEMP\\nvm-setup.zip"
                        
                        # Unzip the downloaded file
                        Add-Type -AssemblyName System.IO.Compression.FileSystem
                        [System.IO.Compression.ZipFile]::ExtractToDirectory("$env:TEMP\\nvm-setup.zip", "${env.NVM_INSTALL_DIR}")
                        
                        # Add NVM to the machine-level Path
                        [Environment]::SetEnvironmentVariable("Path", "$([Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::Machine));${env.NVM_INSTALL_DIR}", [System.EnvironmentVariableTarget]::Machine)
                        Write-Output "NVM installed and machine-level Path updated."
                    } else {
                        Write-Output "NVM is already installed."
                    }
                }' -Verb RunAs
                """
            }
        }
        stage('Use NVM to Install Node') {
            steps {
                powershell """
                # Start a new PowerShell session to make sure NVM is available
                Start-Process powershell -ArgumentList '-NoProfile -Command { nvm install 18 }' -Wait -Verb RunAs
                """
            }
        }
    }
}
