pipeline {
    agent {
        label 'windows-node'
    }
    environment {
        NVM_VERSION = '1.2.0'
        NVM_URL = 'https://github.com/coreybutler/nvm-windows/releases/download/1.2.0/nvm-setup.zip'
        NVM_INSTALL_DIR = 'C:\\nvm'
    }
    stages {
        stage('Install NVM if not Present') {
            steps {
                powershell """
                Start-Process powershell -ArgumentList '-NoProfile -Command {
                    # Check if the NVM installation directory exists
                    if (-Not (Test-Path "${env.NVM_INSTALL_DIR}")) {
                        New-Item -ItemType Directory -Force -Path "${env.NVM_INSTALL_DIR}"
                    }
                    # Check if NVM is installed
                    if (-Not (Get-Command nvm -ErrorAction SilentlyContinue)) {
                        # Download NVM
                        Invoke-WebRequest -Uri "${env.NVM_URL}" -OutFile "$env:TEMP\\nvm-setup.zip"
                        
                        # Unzip the downloaded file
                        Add-Type -AssemblyName System.IO.Compression.FileSystem
                        [System.IO.Compression.ZipFile]::ExtractToDirectory("$env:TEMP\\nvm-setup.zip", "${env.NVM_INSTALL_DIR}")
                        
                        # Add NVM to the machine-level Path
                        [Environment]::SetEnvironmentVariable("Path", "$([Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::Machine));${env.NVM_INSTALL_DIR}", [System.EnvironmentVariableTarget]::Machine)
                    }
                }' -Verb RunAs
                """
            }
        }
        stage('Use NVM to Install Node') {
            steps {
                powershell """
                # Start a new PowerShell session to make sure NVM is available
                Start-Process powershell -ArgumentList '-NoProfile -Command { nvm install 18 }' -Wait -Verb RunAs
                """
            }
        }
    }
}
